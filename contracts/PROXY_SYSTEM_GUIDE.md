# ๐ Proxy System Guide - ะะฑะฝะพะฒะปัะตะผะฐั ะฐััะธัะตะบัััะฐ ะฑะตะท ะฟะพัะตัะธ ะปะธะบะฒะธะดะฝะพััะธ

## ๐ ะะฑะทะพั

ะะพะฒะฐั ะฟัะพะบัะธ ะฐััะธัะตะบัััะฐ ะฟะพะทะฒะพะปัะตั ะพะฑะฝะพะฒะปััั ะฒะตัะฐ ัะพะบะตะฝะพะฒ ะธ NFT ะฑะตะท ะฟะพัะตัะธ ะปะธะบะฒะธะดะฝะพััะธ ะธ ะดะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน. ะกะธััะตะผะฐ ัะพััะพะธั ะธะท ััะตั ะพัะฝะพะฒะฝัั ะบะพะผะฟะพะฝะตะฝัะพะฒ:

1. **TierWeightManager** - ัะฟัะฐะฒะปัะตั ะฒะตัะฐะผะธ ัะธัะพะฒ
2. **UpgradeableMultiStakeManager** - ะพะฑะฝะพะฒะปัะตะผะฐั ะฒะตััะธั ะพัะฝะพะฒะฝะพะณะพ ะบะพะฝััะฐะบัะฐ
3. **ProxyFactory** - ัะฐะฑัะธะบะฐ ะดะปั ัะพะทะดะฐะฝะธั ะธ ัะฟัะฐะฒะปะตะฝะธั ะฟัะพะบัะธ

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   ProxyFactory  โโโโโโ  ProxyAdmin      โโโโโโ  Proxy Contract โ
โ                  โ    โ                  โ    โ                 โ
โ - createDeploy   โ    โ - upgrade()      โ    โ - User Data     โ
โ - upgradeImpl()  โ    โ - transferOwn()  โ    โ - Positions     โ
โ - updateTier()   โ    โ                  โ    โ - Balances      โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
                                โ
                                โผ
                       โโโโโโโโโโโโโโโโโโโโ
                       โ UpgradeableMulti โ
                       โ StakeManager     โ
                       โ                  โ
                       โ - createPosition โ
                       โ - closePosition   โ
                       โ - mintNFT        โ
                       โโโโโโโโโโโโโโโโโโโโ
                                โ
                                โผ
                       โโโโโโโโโโโโโโโโโโโโ
                       โ TierWeightManagerโ
                       โ                  โ
                       โ - updateTier()   โ
                       โ - getTierConfig()โ
                       โ - validateTier() โ
                       โโโโโโโโโโโโโโโโโโโโ
```

## ๐ง ะัะฝะพะฒะฝัะต ะฒะพะทะผะพะถะฝะพััะธ

### 1. ะะธะฝะฐะผะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฒะตัะพะฒ
- โ ะะทะผะตะฝะตะฝะธะต ััะผะผ ััะตะนะบะธะฝะณะฐ ะดะปั ัะธัะพะฒ
- โ ะะฑะฝะพะฒะปะตะฝะธะต ะฟัะพัะตะฝัะพะฒ ะฝะฐะณัะฐะด
- โ ะะทะผะตะฝะตะฝะธะต ะผะฝะพะถะธัะตะปะตะน NFT
- โ ะะบัะธะฒะฐัะธั/ะดะตะฐะบัะธะฒะฐัะธั ัะธัะพะฒ

### 2. ะะฑะฝะพะฒะปะตะฝะธะต ะปะพะณะธะบะธ ะบะพะฝััะฐะบัะฐ
- โ ะะฑะฝะพะฒะปะตะฝะธะต ะพัะฝะพะฒะฝะพะน ะปะพะณะธะบะธ ะฑะตะท ะฟะพัะตัะธ ะดะฐะฝะฝัั
- โ ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒัั ััะฝะบัะธะน
- โ ะัะฟัะฐะฒะปะตะฝะธะต ะฑะฐะณะพะฒ
- โ ะะฟัะธะผะธะทะฐัะธั ะณะฐะทะฐ

### 3. ะกะพััะฐะฝะตะฝะธะต ะดะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- โ ะัะต ะฟะพะทะธัะธะธ ััะตะนะบะธะฝะณะฐ ัะพััะฐะฝััััั
- โ ะะฐะปะฐะฝัั ัะพะบะตะฝะพะฒ ะฝะต ัะตัััััั
- โ NFT ะพััะฐัััั ะฒ ัะพะฑััะฒะตะฝะฝะพััะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- โ ะะฐััะตัั ะฟัะพะดะพะปะถะฐัั ัะฐะฑะพัะฐัั

## ๐ ะะตะฟะปะพะน ะธ ะฝะฐัััะพะนะบะฐ

### ะจะฐะณ 1: ะะตะฟะปะพะน ัะธััะตะผั

```bash
# ะะตะฟะปะพะน ัะตัะตะท ัะบัะธะฟั ะผะธะณัะฐัะธะธ
npx hardhat run scripts/migrateToProxy.js --network <network>
```

### ะจะฐะณ 2: ะะฐัััะพะนะบะฐ ะฝะฐัะฐะปัะฝัั ะฒะตัะพะฒ

```javascript
const initialTierWeights = [
    {
        minAmount: ethers.parseEther("500"),   // Bronze
        maxAmount: ethers.parseEther("500"),
        duration: 3600, // 1 ัะฐั
        rewardRate: 100, // 1%
        nftMultiplier: 1,
        isActive: true
    },
    // ... ะพััะฐะปัะฝัะต ัะธัั
];
```

### ะจะฐะณ 3: ะะฝัะตะณัะฐัะธั ั ััะพะฝัะตะฝะดะพะผ

```javascript
// ะะพะปััะตะฝะธะต ะฐะดัะตัะฐ ะฟัะพะบัะธ ะธะท deployment-info.json
const deploymentInfo = require('./deployment-info.json');
const proxyAddress = deploymentInfo.proxyAddress;

// ะะพะดะบะปััะตะฝะธะต ะบ ะฟัะพะบัะธ ะบะพะฝััะฐะบัั
const contract = new ethers.Contract(proxyAddress, abi, signer);
```

## ๐ ะะฑะฝะพะฒะปะตะฝะธะต ะฒะตัะพะฒ ัะธัะพะฒ

### ะะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท ProxyFactory

```javascript
// 1. ะกะพะทะดะฐะตะผ ะฝะพะฒัะน TierWeightManager
const newTierWeightManager = await TierWeightManager.deploy();

// 2. ะะฐัััะฐะธะฒะฐะตะผ ะฝะพะฒัะต ะฒะตัะฐ
await newTierWeightManager.updateTierConfig(0, {
    minAmount: ethers.parseEther("600"), // ะะพะฒัะน ะฒะตั ะดะปั Bronze
    maxAmount: ethers.parseEther("600"),
    duration: 3600,
    rewardRate: 150, // ะฃะฒะตะปะธัะตะฝะฝะฐั ะฝะฐะณัะฐะดะฐ
    nftMultiplier: 2, // ะะพะปััะต NFT
    isActive: true
});

// 3. ะะฑะฝะพะฒะปัะตะผ ะฒ ะฟัะพะบัะธ
await proxyFactory.updateTierWeightManager(
    deploymentId,
    await newTierWeightManager.getAddress()
);
```

### ะััะผะพะต ะพะฑะฝะพะฒะปะตะฝะธะต (ะตัะปะธ ั ะฒะฐั ะตััั ะฟัะฐะฒะฐ)

```javascript
// ะะฑะฝะพะฒะปะตะฝะธะต ะฒะตัะฐ ะบะพะฝะบัะตัะฝะพะณะพ ัะธัะฐ
await tierWeightManager.updateTierConfig(0, newConfig);

// ะะบัะธะฒะฐัะธั/ะดะตะฐะบัะธะฒะฐัะธั ัะธัะฐ
await tierWeightManager.setTierActive(0, false);
```

## โฌ๏ธ ะะฑะฝะพะฒะปะตะฝะธะต ัะตะฐะปะธะทะฐัะธะธ

### ะะฑะฝะพะฒะปะตะฝะธะต ะปะพะณะธะบะธ ะบะพะฝััะฐะบัะฐ

```javascript
// 1. ะะตะฟะปะพะธะผ ะฝะพะฒัั ัะตะฐะปะธะทะฐัะธั
const newImplementation = await UpgradeableMultiStakeManager.deploy(
    stakingTokenAddress,
    tierWeightManagerAddress
);

// 2. ะะฑะฝะพะฒะปัะตะผ ัะตัะตะท ProxyFactory
await proxyFactory.upgradeImplementation(
    deploymentId,
    await newImplementation.getAddress()
);
```

### ะะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท ProxyAdmin ะฝะฐะฟััะผัั

```javascript
const proxyAdmin = ProxyAdmin.attach(proxyAdminAddress);
await proxyAdmin.upgrade(proxyAddress, newImplementationAddress);
```

## ๐ ะะพะฝะธัะพัะธะฝะณ ะธ ะฐะฝะฐะปะธัะธะบะฐ

### ะะพะปััะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพ ะดะตะฟะปะพะต

```javascript
// ะะฝัะพัะผะฐัะธั ะพ ะดะตะฟะปะพะต
const deploymentInfo = await proxyFactory.getDeploymentInfo(deploymentId);

// ะะบัะธะฒะฝัะต ะดะตะฟะปะพะธ
const activeDeployments = await proxyFactory.getActiveDeployments();

// ะะตััะธั ะบะพะฝัะธะณััะฐัะธะธ
const configVersion = await contract.getConfigVersion();
```

### ะััะปะตะถะธะฒะฐะฝะธะต ะธะทะผะตะฝะตะฝะธะน

```javascript
// ะกะปััะฐะตะผ ัะพะฑััะธั ะพะฑะฝะพะฒะปะตะฝะธั
contract.on("TierConfigUpdated", (tier, config, version) => {
    console.log(`Tier ${tier} updated to version ${version}`);
});

// ะัะพะฒะตััะตะผ, ะพะฑะฝะพะฒะธะปะฐัั ะปะธ ะบะพะฝัะธะณััะฐัะธั ะดะปั ะฟะพะทะธัะธะธ
const { isConfigUpdated } = await contract.getPositionWithConfig(positionId);
```

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### ะะพะปะธ ะธ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ

- **DEFAULT_ADMIN_ROLE**: ะะพะปะฝัะน ะบะพะฝััะพะปั ะฝะฐะด ัะธััะตะผะพะน
- **ADMIN_ROLE**: ะฃะฟัะฐะฒะปะตะฝะธะต ะฝะฐัััะพะนะบะฐะผะธ ะบะพะฝััะฐะบัะฐ
- **UPGRADER_ROLE**: ะะฑะฝะพะฒะปะตะฝะธะต ัะตะฐะปะธะทะฐัะธะธ ะธ TierWeightManager
- **WEIGHT_UPDATER_ROLE**: ะะฑะฝะพะฒะปะตะฝะธะต ะฒะตัะพะฒ ัะธัะพะฒ

### ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ะฑะตะทะพะฟะฐัะฝะพััะธ

1. **ะัะปััะธัะธะณ**: ะัะฟะพะปัะทัะนัะต ะผัะปััะธัะธะณ ะดะปั ะบัะธัะธัะตัะบะธั ะพะฟะตัะฐัะธะน
2. **ะขะฐะนะผะปะพะบ**: ะะพะฑะฐะฒััะต ะทะฐะดะตัะถะบั ะดะปั ะพะฑะฝะพะฒะปะตะฝะธะน
3. **ะขะตััะธัะพะฒะฐะฝะธะต**: ะัะตะณะดะฐ ัะตััะธััะนัะต ะพะฑะฝะพะฒะปะตะฝะธั ะฝะฐ ัะตััะพะฒะพะน ัะตัะธ
4. **ะะตะทะตัะฒะฝัะต ะบะพะฟะธะธ**: ะกะพััะฐะฝัะนัะต ัะตะทะตัะฒะฝัะต ะบะพะฟะธะธ ะดะฐะฝะฝัั

## ๐จ ะะธะณัะฐัะธั ัััะตััะฒัััะธั ะฟะพะทะธัะธะน

### ะะปะฐะฝ ะผะธะณัะฐัะธะธ

1. **ะะพะดะณะพัะพะฒะบะฐ**: ะกะพะทะดะฐะฝะธะต ะฟัะพะบัะธ ัะธััะตะผั
2. **ะฃะฒะตะดะพะผะปะตะฝะธะต**: ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะพ ะผะธะณัะฐัะธะธ
3. **ะะตัะตัะพะด**: ะะพััะตะฟะตะฝะฝัะน ะฟะตัะตัะพะด ะฝะฐ ะฝะพะฒัั ัะธััะตะผั
4. **ะะฐะฒะตััะตะฝะธะต**: ะัะบะปััะตะฝะธะต ััะฐัะพะน ัะธััะตะผั

### ะกะพััะฐะฝะตะฝะธะต ะดะฐะฝะฝัั

```javascript
// ะญะบัะฟะพัั ะดะฐะฝะฝัั ะธะท ััะฐัะพะณะพ ะบะพะฝััะฐะบัะฐ
const oldContract = await ethers.getContractAt("MultiStakeManager", oldAddress);

// ะะพะปััะตะฝะธะต ะฒัะตั ะฟะพะทะธัะธะน
const totalPositions = await oldContract._nextPositionId();
const positions = [];

for (let i = 1; i < totalPositions; i++) {
    const position = await oldContract.positions(i);
    positions.push({
        id: i,
        owner: position.owner,
        amount: position.amount,
        duration: position.duration,
        tier: position.tier,
        // ... ะพััะฐะปัะฝัะต ะฟะพะปั
    });
}

// ะะผะฟะพัั ะฒ ะฝะพะฒัั ัะธััะตะผั (ะตัะปะธ ะฝะตะพะฑัะพะดะธะผะพ)
```

## ๐ ะัะตะธะผััะตััะฒะฐ ะฝะพะฒะพะน ัะธััะตะผั

### ะะปั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- โ ะกัะฐะฑะธะปัะฝะพััั: ะดะฐะฝะฝัะต ะฝะธะบะพะณะดะฐ ะฝะต ัะตัััััั
- โ ะะธะฑะบะพััั: ะฒะพะทะผะพะถะฝะพััั ะธะทะผะตะฝะตะฝะธั ััะปะพะฒะธะน ััะตะนะบะธะฝะณะฐ
- โ ะัะพะทัะฐัะฝะพััั: ะฒัะต ะธะทะผะตะฝะตะฝะธั ะพััะปะตะถะธะฒะฐัััั

### ะะปั ัะฐะทัะฐะฑะพััะธะบะพะฒ
- โ ะะฑะฝะพะฒะปัะตะผะพััั: ะปะตะณะบะพ ะดะพะฑะฐะฒะปััั ะฝะพะฒัะต ััะฝะบัะธะธ
- โ ะะฐัััะฐะฑะธััะตะผะพััั: ัะธััะตะผะฐ ัะฐััะตั ะฒะผะตััะต ั ะฟัะพะตะบัะพะผ
- โ ะะพะดะดะตัะถะธะฒะฐะตะผะพััั: ะฟัะพััะพะต ะธัะฟัะฐะฒะปะตะฝะธะต ะฑะฐะณะพะฒ

### ะะปั ะฑะธะทะฝะตัะฐ
- โ ะะดะฐะฟัะธะฒะฝะพััั: ะฑััััะพะต ัะตะฐะณะธัะพะฒะฐะฝะธะต ะฝะฐ ะธะทะผะตะฝะตะฝะธั ััะฝะบะฐ
- โ ะะพะฝะบััะตะฝัะพัะฟะพัะพะฑะฝะพััั: ะฒะพะทะผะพะถะฝะพััั ัะปัััะตะฝะธั ััะปะพะฒะธะน
- โ ะะพะฒะตัะธะต: ะฟะพะปัะทะพะฒะฐัะตะปะธ ะทะฝะฐัั, ััะพ ะธั ะดะฐะฝะฝัะต ะฒ ะฑะตะทะพะฟะฐัะฝะพััะธ

## ๐๏ธ Troubleshooting

### ะงะฐัััะต ะฟัะพะฑะปะตะผั

1. **ะัะธะฑะบะฐ "Already initialized"**
   - ะะตัะตะฝะธะต: ะฃะฑะตะดะธัะตัั, ััะพ initialize() ะฒัะทัะฒะฐะตััั ัะพะปัะบะพ ะพะดะธะฝ ัะฐะท

2. **ะัะธะฑะบะฐ "Invalid tier"**
   - ะะตัะตะฝะธะต: ะัะพะฒะตัััะต, ััะพ ัะธั ะฐะบัะธะฒะตะฝ ะฒ TierWeightManager

3. **ะัะธะฑะบะฐ "Zero address"**
   - ะะตัะตะฝะธะต: ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต ะฐะดัะตัะฐ ะบะพััะตะบัะฝะพ ะฟะตัะตะดะฐะฝั

### ะะพะณะธ ะธ ะพัะปะฐะดะบะฐ

```javascript
// ะะบะปััะตะฝะธะต ะฟะพะดัะพะฑะฝัั ะปะพะณะพะฒ
const provider = new ethers.JsonRpcProvider(rpcUrl);
provider.on("debug", (info) => {
    console.log("Debug:", info);
});
```

## ๐ ะะพะดะดะตัะถะบะฐ

ะัะธ ะฒะพะทะฝะธะบะฝะพะฒะตะฝะธะธ ะฟัะพะฑะปะตะผ:
1. ะัะพะฒะตัััะต ะปะพะณะธ ััะฐะฝะทะฐะบัะธะน
2. ะฃะฑะตะดะธัะตัั ะฒ ะบะพััะตะบัะฝะพััะธ ะฐะดัะตัะพะฒ
3. ะัะพะฒะตัััะต ะฟัะฐะฒะฐ ะดะพัััะฟะฐ
4. ะะฑัะฐัะธัะตัั ะบ ะบะพะผะฐะฝะดะต ัะฐะทัะฐะฑะพัะบะธ

---

**ะะฐะถะฝะพ**: ะัะตะณะดะฐ ัะตััะธััะนัะต ะพะฑะฝะพะฒะปะตะฝะธั ะฝะฐ ัะตััะพะฒะพะน ัะตัะธ ะฟะตัะตะด ะฟัะธะผะตะฝะตะฝะธะตะผ ะฒ ะฟัะพะดะฐะบัะตะฝะต!

